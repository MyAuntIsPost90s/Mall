<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=0">

    <title>订单管理</title>

    <link href="Contents/lib/AmazeUI-2.4.2/assets/css/admin.css" rel="stylesheet" type="text/css">
    <link href="Contents/lib/AmazeUI-2.4.2/assets/css/amazeui.css" rel="stylesheet" type="text/css">

    <link href="Contents/css/personal.css" rel="stylesheet" type="text/css">
    <link href="Contents/css/orstyle.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="Contents/lib/layui/css/layui.css">
    <link href="Contents/css/hmstyle.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="Contents/css/info.css">

    <script src="Contents/js/jquery.min.js"></script>
    <script src="Contents/js/config.js"></script>
    <script src="Contents/lib/lingshiframework/lingshi_base.js"></script>
    <script src="Contents/lib/AmazeUI-2.4.2/assets/js/amazeui.js"></script>
</head>

<body>
<header>
    <article>
        <div class="mt-logo">
            <!--顶部导航条 -->
            <div id="ctrl-header-nav"></div>

            <!--悬浮搜索框-->
            <div class="nav white">
                <div class="logoBig">
                    <li><img src="Contents/images/logobig.png"/></li>
                </div>

                <div class="search-bar pr">
                    <a name="index_none_header_sysc" href="#"></a>
                    <form id="form-search" action="search.html">
                        <input id="inp-goodskindid" name="goodskindid" type="hidden" value=""/>
                        <input id="searchInput" name="goodsname" type="text" placeholder="搜索" autocomplete="off">
                        <input id="ai-topsearch" class="submit am-btn" value="搜索" index="1" type="submit">
                    </form>
                </div>
            </div>

            <div class="clear"></div>
        </div>
    </article>
</header>
<!-- 物品分类组件 -->
<div id="div-nav-goodskind"></div>
<b class="line"></b>
<div class="center">
    <div class="col-main">
        <div class="main-wrap">

            <div class="user-order">

                <!--标题 -->
                <div class="am-cf am-padding">
                    <div class="am-fl am-cf"><strong class="am-text-danger am-text-lg">订单管理</strong> /
                        <small>Order</small>
                    </div>
                </div>
                <hr/>

                <div class="am-tabs am-tabs-d2 am-margin" data-am-tabs>

                    <ul class="am-avg-sm-5 am-tabs-nav am-nav am-nav-tabs">
                        <li class="am-active"><a href="#tab-all">所有订单</a></li>
                        <li><a href="#tab-unsend">待发货</a></li>
                        <li><a href="#tab-unreceive">待收货</a></li>
                        <li><a href="#tab-finished">已完成</a></li>
                    </ul>
                    <!-- 全部 -->
                    <div class="am-tabs-bd">
                        <div class="am-tab-panel am-fade am-in am-active" id="tab-all">
                            <div class="order-top">
                                <div class="th th-item">
                                    <td class="td-inner">商品</td>
                                </div>
                                <div class="th th-price">
                                    <td class="td-inner">单价</td>
                                </div>
                                <div class="th th-number">
                                    <td class="td-inner">数量</td>
                                </div>
                                <div class="th th-operation">
                                    <td class="td-inner">商品操作</td>
                                </div>
                                <div class="th th-amount">
                                    <td class="td-inner">合计</td>
                                </div>
                                <div class="th th-status">
                                    <td class="td-inner">交易状态</td>
                                </div>
                                <div class="th th-change">
                                    <td class="td-inner">交易操作</td>
                                </div>
                            </div>

                            <div class="order-main">
                                <div class="order-list">

                                </div>
                            </div>

                        </div>
                        <!-- 待发货 -->
                        <div class="am-tab-panel am-fade" id="tab-unsend">

                            <div class="order-top">
                                <div class="th th-item">
                                    <td class="td-inner">商品</td>
                                </div>
                                <div class="th th-price">
                                    <td class="td-inner">单价</td>
                                </div>
                                <div class="th th-number">
                                    <td class="td-inner">数量</td>
                                </div>
                                <div class="th th-operation">
                                    <td class="td-inner">商品操作</td>
                                </div>
                                <div class="th th-amount">
                                    <td class="td-inner">合计</td>
                                </div>
                                <div class="th th-status">
                                    <td class="td-inner">交易状态</td>
                                </div>
                                <div class="th th-change">
                                    <td class="td-inner">交易操作</td>
                                </div>
                            </div>
                            <div class="order-main">
                                <div class="order-list">
                                </div>
                            </div>
                        </div>
                        <!-- 待收货 -->
                        <div class="am-tab-panel am-fade" id="tab-unreceive">
                            <div class="order-top">
                                <div class="th th-item">
                                    <td class="td-inner">商品</td>
                                </div>
                                <div class="th th-price">
                                    <td class="td-inner">单价</td>
                                </div>
                                <div class="th th-number">
                                    <td class="td-inner">数量</td>
                                </div>
                                <div class="th th-operation">
                                    <td class="td-inner">商品操作</td>
                                </div>
                                <div class="th th-amount">
                                    <td class="td-inner">合计</td>
                                </div>
                                <div class="th th-status">
                                    <td class="td-inner">交易状态</td>
                                </div>
                                <div class="th th-change">
                                    <td class="td-inner">交易操作</td>
                                </div>
                            </div>

                            <div class="order-main">
                                <div class="order-list">

                                </div>
                            </div>
                        </div>
                        <!-- 已完成 -->
                        <div class="am-tab-panel am-fade" id="tab-finished">
                            <div class="order-top">
                                <div class="th th-item">
                                    <td class="td-inner">商品</td>
                                </div>
                                <div class="th th-price">
                                    <td class="td-inner">单价</td>
                                </div>
                                <div class="th th-number">
                                    <td class="td-inner">数量</td>
                                </div>
                                <div class="th th-operation">
                                    <td class="td-inner">商品操作</td>
                                </div>
                                <div class="th th-amount">
                                    <td class="td-inner">合计</td>
                                </div>
                                <div class="th th-status">
                                    <td class="td-inner">交易状态</td>
                                </div>
                                <div class="th th-change">
                                    <td class="td-inner">交易操作</td>
                                </div>
                            </div>

                            <div class="order-main">
                                <div class="order-list">

                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <!--底部-->
        <div class="footer">
            <div class="footer-hd">
                <p>
                    <a href="#">恒望科技</a>
                    <b>|</b>
                    <a href="#">商城首页</a>
                    <b>|</b>
                    <a href="#">支付宝</a>
                    <b>|</b>
                    <a href="#">物流</a>
                </p>
            </div>
            <div class="footer-bd">
                <p>
                    <a href="#">关于恒望</a>
                    <a href="#">合作伙伴</a>
                    <a href="#">联系我们</a>
                    <a href="#">网站地图</a>
                    <em>© 备个鬼案</em>
                </p>
            </div>

        </div>
    </div>
    <aside class="menu">
        <ul>
            <li class="person">
                <a href="index.html">个人中心</a>
            </li>
            <li class="person">
                <a href="#">个人资料</a>
                <ul>
                    <li><a href="information.html">个人信息</a></li>
                    <li><a href="safety.html">安全设置</a></li>
                    <li><a href="address.html">收货地址</a></li>
                </ul>
            </li>
            <li class="person">
                <a href="#">我的交易</a>
                <ul>
                    <li class="active"><a href="order.html">订单管理</a></li>
                    <li><a href="feedback.html">售后反馈</a></li>
                </ul>
            </li>
        </ul>

    </aside>
</div>
<script id="lay-order" type="text/html">
    {{#  layui.each(d, function(index, item){ }}
    <div class="order-status5">
        <div class="order-title">
            <div class="dd-num">订单编号：<a href="javascript:;">{{ item.orderid }}</a></div>
            <span>成交时间：{{ item.ordertime }}</span>
            <!--    <em>店铺：小桔灯</em>-->
        </div>
        <div class="order-content">
            <div class="order-left">
                {{#  layui.each(item.ordergoods, function(index, ordergoods){ }}
                <ul class="item-list">
                    <li class="td td-item">
                        <div class="item-pic">
                            <a href="introduction.html?goodsid={{ ordergoods.goodsid }}" class="J_MakePoint">
                                <img src="{{ ordergoods.ordergoodsimgurl==''?'Contents/images/imgsearch1.jpg':(Config.UrlHead + ordergoods.ordergoodsimgurl) }}"
                                     class="itempic J_ItemImg" width="80px" height="80px">
                            </a>
                        </div>
                        <div class="item-info">
                            <div class="item-basic-info">
                                <a href="introduction.html?goodsid={{ ordergoods.goodsid }}" >
                                    <p>{{ ordergoods.ordergoodsname }}</p>
                                </a>
                            </div>
                        </div>
                    </li>
                    <li class="td td-price">
                        <div class="item-price">
                            {{ ordergoods.ordergoodscount * ordergoods.ordergoodsprice }}
                        </div>
                    </li>
                    <li class="td td-number">
                        <div class="item-number">
                            <span>×</span>{{ ordergoods.ordergoodscount }}
                        </div>
                    </li>
                    <li class="td td-operation">
                        <div class="item-operation">

                        </div>
                    </li>
                </ul>
                {{# }) }}
            </div>
            <div class="order-right">
                <li class="td td-amount">
                    <div class="item-amount">
                        合计：{{ item.orderprice }}
                        <p>运费：<span>包邮</span></p>
                    </div>
                </li>
                <div class="move-right">
                    <li class="td td-status">
                        <div class="item-status">
                            <p class="Mystatus">交易成功</p>
                            <p class="order-info"><a style="cursor: pointer" data-id="{{ item.orderid }}" class="btn-orderflow" >查看物流</a></p>
                        </div>
                    </li>
                    <li class="td td-change">
                        {{ item.orderstatus==0?'未发货':(item.orderstatus==1?'':'已完成') }}
                        {{# if(item.orderstatus==1){ }}
                        <div data-id="{{ item.orderid }}" class="am-btn am-btn-danger anniu btn-finished">
                            确认收货
                        </div>
                        {{# } }}
                    </li>
                </div>
            </div>
        </div>
    </div>
    {{# }); }}
</script>
<script id="lay-orderform" type="text/html">
    <div style="padding: 10px;">
        <form class="layui-form layui-form-pane" id="form-orderform">
            <input id="opt-type" type="hidden" name="type" />
            <input id="orderid" name="orderid" type="hidden" >
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">流程</label>
                <div class="layui-input-block">
                    <textarea id="ta-orderflow" readonly class="layui-textarea" style="width: 300px;height: 100px"></textarea>
                </div>
            </div>
        </form>
    </div>
</script>
<script src="Contents/js/mall.dao.js"></script>
<script src="Contents/lib/layui/layui.all.js"></script>
<script src="Contents/js/mall.service.js"></script>
</body>
<script>
    //订单服务
    function OrderService(){
        var headerService = new HeaderService();
        var barService = new GoodsKindBarService();

        this.init = function () {
            headerService.init();
            barService.init();

            loadData();
        }

        //加载数据
        function loadData() {
            var orderFormDao=new OrderFormDao();

            //加载用户所有订单
            orderFormDao.orderWithGoods({page:1,rows:999},function (data) {
                if(data.code!=1){
                    layer.msg(data.msg);
                    return;
                }
                if(data.data==null||data.data.rows.length<1){
                    return;
                }
                var all=[];
                var unsend=[];
                var unrecieve=[];
                var finished=[];
                var list=data.data.rows;
                for(var i=0;i<list.length;i++){
                    all.push(list[i]);
                    if(list[i].orderstatus==0){
                        unsend.push(list[i]);
                    }
                    if(list[i].orderstatus==1){
                        unrecieve.push(list[i]);
                    }
                    if(list[i].orderstatus==2){
                        finished.push(list[i]);
                    }
                }

                var tempStr = $('#lay-order').html();
                layui.laytpl(tempStr).render(all, function(html){
                    $('#tab-all').find('.order-list').html(html);
                });
                layui.laytpl(tempStr).render(unsend, function(html){
                    $('#tab-unsend').find('.order-list').html(html);
                });
                layui.laytpl(tempStr).render(unrecieve, function(html){
                    $('#tab-unreceive').find('.order-list').html(html);
                });
                layui.laytpl(tempStr).render(finished, function(html){
                    $('#tab-finished').find('.order-list').html(html);
                });
                bindEvent();
            })
        }

        //绑定点击事件
        function bindEvent(){
            $('.btn-finished').unbind();
            $('.btn-finished').click(function () {
                var orderid=$(this).attr('data-id');
                var orderFormDao=new OrderFormDao();
                orderFormDao.update({orderid:orderid,orderstatus:2}
                    ,function(data){
                    layer.msg(data.msg);
                    if(data.code==1){
                        loadData();
                    }
                });
            });
            $('.btn-orderflow').unbind();
            $('.btn-orderflow').click(function () {
                var orderid=$(this).attr('data-id');
                var orderFormDao=new OrderFormDao();
                orderFormDao.single(orderid
                    ,function(data){
                        layer.open({
                            type:1
                            ,title:'物流详情'
                            ,content:$('#lay-orderform').html()
                            ,success:function(){
                                data.data.type='edit';
                                if(data.code==1){
                                    $('#ta-orderflow').val(data.data.orderflow);
                                    $('#orderid').val(data.data.orderid);
                                }else {
                                    layer.msg(data.msg);
                                }
                            }
                        })
                    });
            });
        }
    }

    var orderService=null;
    $(function(){
        orderService=new OrderService();
        orderService.init();
    });
</script>
</html>